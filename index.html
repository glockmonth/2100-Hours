<script>
const CSV_URL = './statbot.csv'; // Path to your CSV

// Load and parse CSV
async function loadCSV() {
    const res = await fetch(CSV_URL);
    const text = await res.text();
    const rows = text.split('\n').slice(1); // skip header

    const members = rows.map(row => {
        if (!row.trim()) return null;
        // Regex to split CSV correctly even if username has quotes/commas
        const cols = row.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
        if (!cols || cols.length < 4) return null;
        const username = cols[1].replace(/^"|"$/g, '').trim();
        let hours = parseFloat(cols[3]);
        if (isNaN(hours)) hours = 0;
        hours = Math.round(hours * 100) / 100; // round to 2 decimals
        return { username, hours };
    }).filter(Boolean);

    return members;
}

// Populate leaderboard
function renderLeaderboard(members) {
    // Sort descending by hours
    members.sort((a,b) => b.hours - a.hours);

    // Update stats
    document.getElementById('total-members').textContent = members.length;
    const totalHours = members.reduce((sum, m) => sum + m.hours, 0);
    document.getElementById('total-hours').textContent = totalHours.toFixed(2);
    document.getElementById('avg-hours').textContent = 'NaN'; // keep as NaN for now

    // Update podium top 3
    const podiumSelectors = ['.podium-place.first', '.podium-place.second', '.podium-place.third'];
    podiumSelectors.forEach((selector, i) => {
        const el = document.querySelector(selector);
        if (!el) return;
        if (!members[i]) return;
        el.querySelector('.player-name').textContent = members[i].username;
        el.querySelector('.player-hours').textContent = members[i].hours;
    });

    // Update full leaderboard table
    const tbody = document.getElementById('leaderboard-body');
    tbody.innerHTML = '';
    members.forEach((m, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td class="rank-cell">${i + 1}</td>
            <td class="name-cell">${m.username}</td>
            <td>Member</td>
            <td class="hours-cell">${m.hours} hrs</td>
            <td style="color:#00ff00;">‚óè Active</td>
        `;
        tbody.appendChild(tr);
    });
}

// Init
async function initLeaderboard() {
    const members = await loadCSV();
    renderLeaderboard(members);
}

initLeaderboard();
</script>
